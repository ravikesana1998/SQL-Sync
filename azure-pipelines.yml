trigger:
- main

pool:
  name: 'self-hosted-pool'

variables:
  ResourceGroupName: 'rg-23-6'
  ServerName: 'studentserver9'
  HubDatabase: 'studentsdb1'
  SyncGroupName: 'StudentSyncGroup'
  MemberDatabase: 'studentdb2'
  SqlUser: 'ram'
  SqlPassword: 'Shree@123'

steps:

# ðŸ”¹ Step 1: Setup SQL Data Sync Group & Member
- task: AzurePowerShell@5
  displayName: 'Setup SQL Data Sync'
  inputs:
    azureSubscription: 'DevopsServiceConnection'
    ScriptPath: 'setup-sql-sync.ps1'
    ScriptArguments: >
      -ResourceGroupName $(ResourceGroupName)
      -ServerName $(ServerName)
      -HubDatabase $(HubDatabase)
      -MemberDatabase $(MemberDatabase)
      -SyncGroupName $(SyncGroupName)
    azurePowerShellVersion: 'LatestVersion'
    pwsh: true

# ðŸ”¹ Step 2: Generate FK-Aware Sync Order
- task: AzurePowerShell@5
  displayName: 'Generate FK Table Order'
  inputs:
    azureSubscription: 'DevopsServiceConnection'
    ScriptPath: 'generate-sync-order.ps1'
    ScriptArguments: >
      -SqlServerName "$(ServerName).database.windows.net"
      -DatabaseName "$(HubDatabase)"
      -Username "ram"
      -Password "Shree@123"
      -OutputFile "$(Pipeline.Workspace)/sync-table-order.txt"
    azurePowerShellVersion: 'LatestVersion'
    pwsh: true


# ðŸ”¹ Step 3: Register Tables in FK Order
- task: AzurePowerShell@5
  displayName: 'Register FK-Aware Sync Tables'
  inputs:
    azureSubscription: 'DevopsServiceConnection'
    ScriptPath: 'scripts/register-tables-by-order.ps1'
    ScriptArguments: >
      -ResourceGroupName $(ResourceGroupName)
      -ServerName $(ServerName)
      -HubDatabase $(HubDatabase)
      -SyncGroupName $(SyncGroupName)
      -SyncMemberName Member-$(MemberDatabase)
      -TableListPath "./sync-table-order.txt"
    azurePowerShellVersion: 'LatestVersion'
    pwsh: true

# ðŸ” Step 4: Trigger Sync
- task: AzurePowerShell@5
  displayName: 'Trigger Sync'
  inputs:
    azureSubscription: 'DevopsServiceConnection'
    ScriptPath: 'trigger-sync.ps1'
    ScriptArguments: >
      -ResourceGroupName $(ResourceGroupName)
      -ServerName $(ServerName)
      -DatabaseName $(HubDatabase)
      -SyncGroupName $(SyncGroupName)
    azurePowerShellVersion: 'LatestVersion'
    pwsh: true
