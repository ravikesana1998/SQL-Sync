trigger:
- main

pool:
  name: 'self-hosted-pool'

variables:
  ResourceGroupName: 'rg-23-6'
  ServerName: 'studentserver9'
  HubDatabase: 'studentsdb1'
  SyncGroupName: 'StudentSyncGroup'
  MemberDatabase: 'studentdb2'

steps:

# 🔹 Step 1: Setup SQL Data Sync Group & Member
- task: AzurePowerShell@5
  displayName: 'Setup SQL Data Sync'
  inputs:
    azureSubscription: 'DevopsServiceConnection'
    ScriptPath: 'setup-sql-sync.ps1'
    ScriptArguments: >
      -ResourceGroupName $(ResourceGroupName)
      -ServerName $(ServerName)
      -HubDatabase $(HubDatabase)
      -MemberDatabase $(MemberDatabase)
      -SyncGroupName $(SyncGroupName)
    azurePowerShellVersion: 'LatestVersion'
    pwsh: true

# 🔹 Step 2: Register tables for sync
- task: AzurePowerShell@5
  displayName: 'Register Sync Tables'
  inputs:
    azureSubscription: 'DevopsServiceConnection'
    ScriptPath: 'register-sync-tables.ps1'
    ScriptArguments: >
      -ResourceGroupName $(ResourceGroupName)
      -ServerName $(ServerName)
      -HubDatabase $(HubDatabase)
      -MemberDatabase $(MemberDatabase)
      -SyncGroupName $(SyncGroupName)
    azurePowerShellVersion: 'LatestVersion'
    pwsh: true

# 🔁 Step 3: Trigger Sync
- task: AzurePowerShell@5
  displayName: 'Trigger Sync'
  inputs:
    azureSubscription: 'DevopsServiceConnection'
    ScriptPath: 'trigger-sync.ps1'
    ScriptArguments: >
      -ResourceGroupName $(ResourceGroupName)
      -ServerName $(ServerName)
      -DatabaseName $(HubDatabase)
      -SyncGroupName $(SyncGroupName)
    azurePowerShellVersion: 'LatestVersion'
    pwsh: true
